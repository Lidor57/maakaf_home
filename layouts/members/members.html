{{ define "main" }}
<link rel="stylesheet" href="/css/members.css">

<!-- Page Title -->
<h1><br><br>{{ .Title }}</h1>

<!-- Hebrew Description -->
<p dir="rtl" class="text-right">
  בדף זה תוכלו לראות את רשימת התורמים לקהילה, כולל מידע על תרומתם: קומיטים, בקשות משיכה, תגובות ומספר פרויקטים בהם השתתפו. ניתן למיין ולחפש לפי שם או לפי כמות תרומות.
</p>

<div dir="ltr">

  <!-- ========================
    Search & Sort Controls
  ========================= -->
  <div class="d-flex flex-wrap gap-3 align-items-end mb-4">
    <div>
      <label for="searchInput" class="form-label mb-1">Search by username:</label>
      <input type="text" class="form-control" id="searchInput" onkeyup="filterTable()" placeholder="Type a username..." />
    </div>

    <div>
      <label for="sortOption" class="form-label mb-1">Sort by:</label>
      <select class="form-control" id="sortOption" onchange="sortTable()">
        <option value="alpha">Alphabetical (A–Z)</option>
        <option value="most">Most Contributions</option>
        <option value="least">Least Contributions</option>
      </select>
    </div>
  </div>

  <!-- ========================
    Community Summary Section
  ========================= -->
  {{ $totalCommits := 0 }}
  {{ $totalPRs := 0 }}
  {{ $totalIssues := 0 }}
  {{ $totalPRComments := 0 }}
  {{ $totalIssueComments := 0 }}
  {{ $totalUsers := 0 }}
  {{ $uniqueProjects := dict }}

  {{ range .Site.Data.remote }}
    {{ $totalUsers = add $totalUsers 1 }}
    {{ $totalCommits = add $totalCommits .summary.totalCommits }}
    {{ $totalPRs = add $totalPRs .summary.totalPRs }}
    {{ $totalIssues = add $totalIssues .summary.totalIssues }}
    {{ $totalPRComments = add $totalPRComments .summary.totalPRComments }}
    {{ $totalIssueComments = add $totalIssueComments .summary.totalIssueComments }}
    {{ range .repos }}
      {{ $uniqueProjects = merge $uniqueProjects (dict .url true) }}
    {{ end }}
  {{ end }}

  <div class="community-summary">
    <strong>Community Summary:</strong><br>
    Contributors: {{ $totalUsers }} |
    Projects: {{ len $uniqueProjects }} |
    Commits: {{ $totalCommits }} |
    PRs: {{ $totalPRs }} |
    Issues: {{ $totalIssues }} |
    PR Comments: {{ $totalPRComments }} |
    Issue Comments: {{ $totalIssueComments }}
  </div>

  <!-- ===================
    Contributors Table
  ====================== -->
  <div class="table-container">
    <table id="contributorsTable" class="table table-bordered table-dark">
      <thead class="thead-dark">
        <tr>
          <th>Username</th> <!-- TODO: replace with name when avialable and then fix the searchbox and search function -->
          <th>Total Contributions</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {{ range .Site.Data.remote }}
          {{ $total := add (add (add (add .summary.totalCommits .summary.totalPRs) .summary.totalIssues) .summary.totalPRComments) .summary.totalIssueComments }}
          <tr>
            <td>{{ .username }}</td> <!-- TODO: replace with .name when available -->
            <td class="total">{{ $total }}</td>
            <td>
              <ul>
                <li>Commits: {{ .summary.totalCommits }}</li>
                <li>PRs: {{ .summary.totalPRs }}</li>
                <li>Issues: {{ .summary.totalIssues }}</li>
                <li>PR Comments: {{ .summary.totalPRComments }}</li>
                <li>Issue Comments: {{ .summary.totalIssueComments }}</li>
                <li>Projects Contributed To: {{ len .repos }}</li>
              </ul>
              {{ if gt (len .repos) 0 }}
              <details class="projects-toggle">
                <summary>Show Projects</summary>
                <ul class="project-list">
                  {{ range .repos }}
                    <li><a href="{{ .url }}" target="_blank">{{ .repoName }}</a>  {{ .description }}</li>
                  {{ end }}
                </ul>
              </details>
              {{ end }}
            </td>
          </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  <p class="last-updated">
    Last updated: {{ .Site.Data.remoteGeneratedAt }}
  </p>
</div>

<script>
  function sortTable() {
    const table = document.getElementById("contributorsTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const option = document.getElementById("sortOption").value;

    rows.sort((a, b) => {
      const nameA = a.cells[0].textContent.trim().toLowerCase();
      const nameB = b.cells[0].textContent.trim().toLowerCase();
      const contribA = parseInt(a.cells[1].textContent.trim());
      const contribB = parseInt(b.cells[1].textContent.trim());

      if (option === "most") return contribB - contribA;
      if (option === "least") return contribA - contribB;
      return nameA.localeCompare(nameB);
    });

    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }

  function filterTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("#contributorsTable tbody tr");

    rows.forEach(row => {
      const username = row.cells[0].textContent.toLowerCase();
      row.style.display = username.includes(filter) ? "" : "none";
    });
  }
</script>
{{ end }}
