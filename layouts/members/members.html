{{ define "main" }}
<link rel="stylesheet" href="/css/members.css">

<!-- Full-width wrapper using Docsy's theme-aware styling -->
<div class="container-fluid px-4 my-theme-aware-content" style="color: var(--text-color); background-color: var(--bg-color);">

  <!-- Page Title -->
  <h1><br><br>{{ .Title }}</h1>

  <!-- Hebrew Description -->
  <p dir="rtl" class="text-right">
    {{ .Params.description | default "בדף זה תוכלו לראות את רשימת התורמים לקהילה, כולל מידע על תרומתם: קומיטים, בקשות משיכה, תגובות ומספר פרויקטים בהם השתתפו. ניתן למיין ולחפש לפי שם או לפי כמות תרומות." }}
  </p>

  <div dir="{{ .Params.pageConfig.direction | default "ltr" }}">
    <!-- ========================
      Search Controls (Simplified)
    ========================= -->
    {{ if .Params.pageConfig.showSearch | default true }}
    <div class="d-flex flex-wrap gap-3 align-items-end mb-4">
      <div>
        <label for="searchInput" class="form-label mb-1">{{ .Params.searchConfig.label | default "Search by name, username, or bio:" }}</label>
        <input type="text" class="form-control text-reset" id="searchInput" onkeyup="filterTable()" placeholder="{{ .Params.searchConfig.placeholder | default "Type to search..." }}" />
      </div>
      <small class="text-muted align-self-center">{{ .Params.searchConfig.helpText | default "💡 Click column headers to sort" }}</small>
    </div>
    {{ end }}

    <!-- ========================
      Community Summary Section
    ========================= -->
    {{ if .Params.pageConfig.showCommunityStats | default true }}
    {{ $globalSummary := .Site.Data.github_data.globalSummary }}
    
    <div class="community-summary my-3">
      <strong>Community Summary:</strong><br>
      Contributors: {{ $globalSummary.totalUsers }} |
      Projects: {{ $globalSummary.totalRepos }} |
      Commits: {{ $globalSummary.totalCommits }} |
      PRs: {{ $globalSummary.totalPRs }} |
      Issues: {{ $globalSummary.totalIssues }} |
      PR Comments: {{ $globalSummary.totalPRComments }} |
      Issue Comments: {{ $globalSummary.totalIssueComments }}
      <br><small class="text-muted">Analysis period: {{ $globalSummary.analysisTimeframe }} | Min fork filter: {{ $globalSummary.minForkCountFilter }}</small>
    </div>
    {{ end }}

    <!-- ===================
      Contributors Table
    ====================== -->
    <div class="table-container mb-4">
      <table id="contributorsTable" class="table table-bordered text-reset w-100">
        <thead>
          <tr>
            <th class="sortable" data-column="0" data-type="text">
              User <span class="sort-indicator"></span>
            </th>
            <th class="sortable" data-column="1" data-type="number">
              Commits <span class="sort-indicator"></span>
            </th>
            <th class="sortable" data-column="2" data-type="number">
              PRs <span class="sort-indicator"></span>
            </th>
            <th class="sortable" data-column="3" data-type="number">
              Issues <span class="sort-indicator"></span>
            </th>
            <th class="sortable" data-column="4" data-type="number">
              PR Comments <span class="sort-indicator"></span>
            </th>
            <th class="sortable" data-column="5" data-type="number">
              Issue Comments <span class="sort-indicator"></span>
            </th>
            <th class="sortable" data-column="total" data-type="number">
              Total <span class="sort-indicator"></span>
            </th>
            <th>Projects</th>
          </tr>
        </thead>
        <tbody>
          {{ range .Site.Data.github_data.users }}
            {{ $total := add (add (add (add .summary.totalCommits .summary.totalPRs) .summary.totalIssues) .summary.totalPRComments) .summary.totalIssueComments }}
            <tr>
              <td>
                <div class="username-cell d-flex align-items-center gap-2">
                  <img src="{{ .user.avatarUrl }}" alt="{{ .user.username }}" class="avatar" />
                  <div>
                    <div>
                      <a href="https://github.com/{{ .user.username }}" target="_blank" class="text-decoration-none">
                        <strong>{{ .user.displayName | default .user.username }}</strong>
                      </a>
                      <small class="text-muted">(@{{ .user.username }})</small>
                    </div>
                    {{ if .user.bio }}
                      <small class="text-muted d-block">{{ .user.bio }}</small>
                    {{ end }}
                    {{ if or .user.location .user.company }}
                      <small class="text-muted d-block">
                        {{ if .user.location }}📍 {{ .user.location }}{{ end }}
                        {{ if and .user.location .user.company }} | {{ end }}
                        {{ if .user.company }}🏢 {{ .user.company }}{{ end }}
                      </small>
                    {{ end }}
                  </div>
                </div>
              </td>
              <td>{{ .summary.totalCommits }}</td>
              <td>{{ .summary.totalPRs }}</td>
              <td>{{ .summary.totalIssues }}</td>
              <td>{{ .summary.totalPRComments }}</td>
              <td>{{ .summary.totalIssueComments }}</td>
              <td class="total-cell">{{ $total }}</td>
              <td>
                {{ if gt (len .repos) 0 }}
                  <details class="projects-toggle">
                    <summary>{{ len .repos }} projects</summary>
                    <ul class="project-list mt-2">
                      {{ range .repos }}
                        <li>
                          <a href="{{ .url }}" target="_blank">{{ .repoName }}</a>
                          {{ if .description }} – {{ .description }}{{ end }}
                          <br><small class="text-muted">
                            C:{{ .commits }} | PR:{{ .pullRequests }} | I:{{ .issues }} | PRC:{{ .prComments }} | IC:{{ .issueComments }}
                          </small>
                        </li>
                      {{ end }}
                    </ul>
                  </details>
                {{ else }}
                  —
                {{ end }}
              </td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>

    <p class="last-updated mb-5">
      Last updated: {{ dateFormat (.Params.lastUpdatedFormat | default "2006-01-02 15:04:05") now }}{{ if .Params.showDataGenerationDate | default true }} | 
      Data generated: {{ .Site.Data.github_data.globalSummary.analysisTimeframe }}{{ end }}
    </p>
  </div>
</div>

<!-- ========================
  Scripts for Sort & Filter
========================= -->
<style>
  .sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px !important;
  }
  
  .sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  .sort-indicator {
    position: absolute;
    right: 8px;
    color: #ccc;
    font-size: 16px;
    font-weight: bold;
  }
  
  .sortable.sort-asc .sort-indicator::after {
    content: "▲";
    color: #007bff;
  }
  
  .sortable.sort-desc .sort-indicator::after {
    content: "▼";
    color: #007bff;
  }
  
  .sortable:not(.sort-asc):not(.sort-desc) .sort-indicator::after {
    content: "⇅";
    font-size: 14px;
    opacity: 0.4;
  }
</style>

<script>
  let currentSort = { column: null, direction: null };

  // Initialize sortable headers
  document.addEventListener('DOMContentLoaded', function() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
      header.addEventListener('click', function() {
        const column = this.getAttribute('data-column');
        const type = this.getAttribute('data-type');
        sortTable(column, type, this);
      });
    });
  });

  function sortTable(column, type, headerElement) {
    const table = document.getElementById("contributorsTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    
    // Determine sort direction
    let direction = 'asc';
    if (currentSort.column === column && currentSort.direction === 'asc') {
      direction = 'desc';
    }
    
    // Update sort indicators
    document.querySelectorAll('.sortable').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
    });
    headerElement.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
    
    // Sort rows
    rows.sort((a, b) => {
      let valueA, valueB;
      
      if (column === 'total') {
        // Calculate total for both rows
        valueA = parseInt(a.cells[1].textContent.trim()) + 
                 parseInt(a.cells[2].textContent.trim()) + 
                 parseInt(a.cells[3].textContent.trim()) + 
                 parseInt(a.cells[4].textContent.trim()) + 
                 parseInt(a.cells[5].textContent.trim());
        valueB = parseInt(b.cells[1].textContent.trim()) + 
                 parseInt(b.cells[2].textContent.trim()) + 
                 parseInt(b.cells[3].textContent.trim()) + 
                 parseInt(b.cells[4].textContent.trim()) + 
                 parseInt(b.cells[5].textContent.trim());
      } else if (type === 'text') {
        // For user column, get the display name
        valueA = a.cells[column].querySelector('strong').textContent.trim().toLowerCase();
        valueB = b.cells[column].querySelector('strong').textContent.trim().toLowerCase();
      } else {
        // For numeric columns
        valueA = parseInt(a.cells[column].textContent.trim()) || 0;
        valueB = parseInt(b.cells[column].textContent.trim()) || 0;
      }
      
      let comparison = 0;
      if (type === 'text') {
        comparison = valueA.localeCompare(valueB);
      } else {
        comparison = valueA - valueB;
      }
      
      return direction === 'desc' ? -comparison : comparison;
    });
    
    // Update current sort state
    currentSort = { column, direction };
    
    // Re-insert sorted rows
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }

  function filterTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("#contributorsTable tbody tr");

    rows.forEach(row => {
      const userCell = row.cells[0];
      const displayName = userCell.querySelector('strong').textContent.toLowerCase();
      const username = userCell.textContent.toLowerCase();
      const bio = userCell.textContent.toLowerCase();
      
      // Search in display name, username, bio, location, and company
      const isVisible = displayName.includes(filter) || 
                       username.includes(filter) || 
                       bio.includes(filter);
      
      row.style.display = isVisible ? "" : "none";
    });
  }
</script>
{{ end }}
