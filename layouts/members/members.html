{{ define "main" }}
<link rel="stylesheet" href="/css/members.css">

<!-- Full-width wrapper using Docsy's theme-aware styling -->
<div class="container-fluid px-4 my-theme-aware-content" style="color: var(--text-color); background-color: var(--bg-color);">

  <!-- Page Title -->
  <h1><br><br>{{ .Title }}</h1>

  <!-- Hebrew Description -->
  <p dir="rtl" class="text-right">
    בדף זה תוכלו לראות את רשימת התורמים לקהילה, כולל מידע על תרומתם: קומיטים, בקשות משיכה, תגובות ומספר פרויקטים בהם השתתפו. ניתן למיין ולחפש לפי שם או לפי כמות תרומות.
  </p>

  <div dir="ltr">
    <!-- ========================
      Search & Sort Controls
    ========================= -->
    <div class="d-flex flex-wrap gap-3 align-items-end mb-4">
      <div>
        <label for="searchInput" class="form-label mb-1">Search by name, username, or bio:</label>
        <input type="text" class="form-control text-reset" id="searchInput" onkeyup="filterTable()" placeholder="Type to search..." />
      </div>

      <div>
        <label for="sortOption" class="form-label mb-1">Sort by:</label>
        <select class="form-control text-reset" id="sortOption" onchange="sortTable()">
          <option value="alpha">Alphabetical (A–Z)</option>
          <option value="most">Most Contributions</option>
          <option value="least">Least Contributions</option>
        </select>
      </div>
    </div>

    <!-- ========================
      Community Summary Section
    ========================= -->
    {{ $globalSummary := .Site.Data.github_data.globalSummary }}
    
    <div class="community-summary my-3">
      <strong>Community Summary:</strong><br>
      Contributors: {{ $globalSummary.totalUsers }} |
      Projects: {{ $globalSummary.totalRepos }} |
      Commits: {{ $globalSummary.totalCommits }} |
      PRs: {{ $globalSummary.totalPRs }} |
      Issues: {{ $globalSummary.totalIssues }} |
      PR Comments: {{ $globalSummary.totalPRComments }} |
      Issue Comments: {{ $globalSummary.totalIssueComments }}
      <br><small class="text-muted">Analysis period: {{ $globalSummary.analysisTimeframe }} | Min fork filter: {{ $globalSummary.minForkCountFilter }}</small>
    </div>

    <!-- ===================
      Contributors Table
    ====================== -->
    <div class="table-container mb-4">
      <table id="contributorsTable" class="table table-bordered text-reset w-100">
        <thead>
          <tr>
            <th>User</th>
            <th>Total</th>
            <th>Commits</th>
            <th>PRs</th>
            <th>Issues</th>
            <th>PR Comments</th>
            <th>Issue Comments</th>
            <th>Projects</th>
          </tr>
        </thead>
        <tbody>
          {{ range .Site.Data.github_data.users }}
            {{ $total := add (add (add (add .summary.totalCommits .summary.totalPRs) .summary.totalIssues) .summary.totalPRComments) .summary.totalIssueComments }}
            <tr>
              <td>
                <div class="username-cell d-flex align-items-center gap-2">
                  <img src="{{ .user.avatarUrl }}" alt="{{ .user.username }}" class="avatar" />
                  <div>
                    <div>
                      <a href="https://github.com/{{ .user.username }}" target="_blank" class="text-decoration-none">
                        <strong>{{ .user.displayName | default .user.username }}</strong>
                      </a>
                      <small class="text-muted">(@{{ .user.username }})</small>
                    </div>
                    {{ if .user.bio }}
                      <small class="text-muted d-block">{{ .user.bio }}</small>
                    {{ end }}
                    {{ if or .user.location .user.company }}
                      <small class="text-muted d-block">
                        {{ if .user.location }}📍 {{ .user.location }}{{ end }}
                        {{ if and .user.location .user.company }} | {{ end }}
                        {{ if .user.company }}🏢 {{ .user.company }}{{ end }}
                      </small>
                    {{ end }}
                  </div>
                </div>
              </td>
              <td class="total">{{ $total }}</td>
              <td>{{ .summary.totalCommits }}</td>
              <td>{{ .summary.totalPRs }}</td>
              <td>{{ .summary.totalIssues }}</td>
              <td>{{ .summary.totalPRComments }}</td>
              <td>{{ .summary.totalIssueComments }}</td>
              <td>
                {{ if gt (len .repos) 0 }}
                  <details class="projects-toggle">
                    <summary>{{ len .repos }} projects</summary>
                    <ul class="project-list mt-2">
                      {{ range .repos }}
                        <li>
                          <a href="{{ .url }}" target="_blank">{{ .repoName }}</a>
                          {{ if .description }} – {{ .description }}{{ end }}
                          <br><small class="text-muted">
                            C:{{ .commits }} | PR:{{ .pullRequests }} | I:{{ .issues }} | PRC:{{ .prComments }} | IC:{{ .issueComments }}
                          </small>
                        </li>
                      {{ end }}
                    </ul>
                  </details>
                {{ else }}
                  —
                {{ end }}
              </td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>

    <p class="last-updated mb-5">
      Last updated: {{ dateFormat "2006-01-02 15:04:05" now }} | 
      Data generated: {{ .Site.Data.github_data.globalSummary.analysisTimeframe }}
    </p>
  </div>
</div>

<!-- ========================
  Scripts for Sort & Filter
========================= -->
<script>
  function sortTable() {
    const table = document.getElementById("contributorsTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const option = document.getElementById("sortOption").value;

    rows.sort((a, b) => {
      // Get the display name or username from the first cell
      const nameA = a.cells[0].querySelector('strong').textContent.trim().toLowerCase();
      const nameB = b.cells[0].querySelector('strong').textContent.trim().toLowerCase();
      const contribA = parseInt(a.cells[1].textContent.trim());
      const contribB = parseInt(b.cells[1].textContent.trim());

      if (option === "most") return contribB - contribA;
      if (option === "least") return contribA - contribB;
      return nameA.localeCompare(nameB);
    });

    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }

  function filterTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("#contributorsTable tbody tr");

    rows.forEach(row => {
      const userCell = row.cells[0];
      const displayName = userCell.querySelector('strong').textContent.toLowerCase();
      const username = userCell.textContent.toLowerCase();
      const bio = userCell.textContent.toLowerCase();
      
      // Search in display name, username, bio, location, and company
      const isVisible = displayName.includes(filter) || 
                       username.includes(filter) || 
                       bio.includes(filter);
      
      row.style.display = isVisible ? "" : "none";
    });
  }
</script>
{{ end }}
